<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Bot WhatsApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <ul class="nav nav-tabs mb-3" id="tabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#dashboard">Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#grupos">Gerenciar Grupos</a>
      </li>
    </ul>

    <div class="modal fade" id="modalQr" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">üîë Conectar WhatsApp</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <div id="qrcode"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <h1 class="mb-4 text-center">ü§ñ Dashboard do Bot WhatsApp</h1>

    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" onclick="iniciarBot()">‚ñ∂Ô∏è Iniciar</button>
      <button class="btn btn-danger" onclick="pararBot()">‚èπÔ∏è Parar</button>
      
      <div class="input-group w-auto">
        <span class="input-group-text">‚è±Ô∏è Intervalo (min)</span>
        <input type="number" id="intervalo" class="form-control" placeholder="Minutos">
      </div>

      <div class="input-group w-auto">
        <span class="input-group-text">üê¢ Delay (ms)</span>
        <input type="number" id="delay" class="form-control" placeholder="Milissegundos">
      </div>

      <button class="btn btn-warning" onclick="atualizarConfig()">üíæ Salvar Configura√ß√£o</button>

      <button id="botao-acao" class="btn btn-outline-primary" onclick="acaoBot()">üîÑ Verificando...</button>
    </div>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="dashboard">

        <div class="mb-4">
          <h4>üñ•Ô∏è Logs do Bot</h4>
          <div id="logs" class="border rounded p-3 bg-white" style="height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="mb-4">
          <h4>ü©∫ Status do Sistema</h4>
          <div id="health-status" class="list-group">
            <div class="list-group-item">Verificando status...</div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="m-0">üìú Hist√≥rico de Mensagens</h4>
          <button class="btn btn-primary" onclick="carregarMensagens()">üîÑ Atualizar Mensagens</button>
        </div>

        <canvas id="chart" height="100" class="mb-4"></canvas>

        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>Grupo</th>
              <th>Mensagem</th>
              <th>Data/Hora</th>
            </tr>
          </thead>
          <tbody id="tabela-mensagens"></tbody>
        </table>
      </div>

      <div class="tab-pane fade" id="grupos">
        <h4 class="mb-3">üîó Gerenciar Grupos N√£o Sincronizados</h4>
        <button class="btn btn-primary mb-2" onclick="carregarGruposNaoSync()">üîÑ Atualizar Lista</button>
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Nome do Grupo</th>
              <th>ID</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="tabela-grupos-nao-sync"></tbody>
        </table>
      </div>

    </div> </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const API_BOT = window.location.origin;
    const socket = io();
    const modalQr = new bootstrap.Modal(document.getElementById('modalQr'));
    const botaoAcao = document.getElementById('botao-acao');

    // üîó Bot√£o conectar/desconectar
    async function verificarStatus() {
      try {
        const res = await fetch(`${API_BOT}/api/status`);
        const { status } = await res.json();

        if (status === 'conectado') {
          botaoAcao.textContent = 'üîå Desconectar WhatsApp';
          botaoAcao.className = 'btn btn-outline-danger';
          botaoAcao.onclick = desconectarBot;
        } else {
          botaoAcao.textContent = 'üîë Conectar WhatsApp';
          botaoAcao.className = 'btn btn-outline-success';
          botaoAcao.onclick = abrirQrCode;
        }
      } catch {
        botaoAcao.textContent = '‚ùå Bot offline';
        botaoAcao.className = 'btn btn-outline-secondary';
        botaoAcao.onclick = () => alert('Servidor n√£o dispon√≠vel');
      }
    }

    // --- NOVA FUN√á√ÉO PARA VERIFICAR A SA√öDE DO SISTEMA ---
    async function verificarSaude() {
        const healthStatusDiv = document.getElementById('health-status');
        try {
            const res = await fetch(`${API_BOT}/api/health`);
            const healthData = await res.json();
            
            healthStatusDiv.innerHTML = ''; // Limpa o status anterior

            for (const checkName in healthData.checks) {
                const check = healthData.checks[checkName];
                const statusClass = check.status === 'ok' ? 'bg-success' : 'bg-danger';
                const statusText = check.status === 'ok' ? 'OK' : 'ERRO';

                const itemHtml = `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${checkName.replace(/_/g, ' ').toUpperCase()}</span>
                        <span>
                            <span class="badge ${statusClass} me-2">${statusText}</span>
                            ${check.message}
                        </span>
                    </div>
                `;
                healthStatusDiv.insertAdjacentHTML('beforeend', itemHtml);
            }

        } catch (error) {
            healthStatusDiv.innerHTML = `
              <div class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                  <span>STATUS GERAL</span>
                  <span>
                      <span class="badge bg-danger me-2">FALHA</span>
                      N√£o foi poss√≠vel conectar ao servidor do bot.
                  </span>
              </div>
            `;
        }
    }


    async function carregarConfig() {
      const res = await fetch('/api/config');
      if (res.ok) {
        const cfg = await res.json();
        document.getElementById('intervalo').value = cfg.intervaloMinutos;
        document.getElementById('delay').value = cfg.delayEnvioMs;
      }
    }

    async function atualizarConfig() {
      const minutos = parseInt(document.getElementById('intervalo').value);
      const delay = parseInt(document.getElementById('delay').value);

      if (!minutos || minutos < 1) {
        return alert('‚ö†Ô∏è Informe um intervalo v√°lido (m√≠nimo 1 minuto)');
      }

      if (!delay || delay < 1000) {
        return alert('‚ö†Ô∏è Informe um delay v√°lido (m√≠nimo 1000ms)');
      }

      const res = await fetch(`${API_BOT}/api/config`, {
        method: 'POST',
        headers: { 'content-type': 'application/json'},
        body: JSON.stringify({
          intervaloMinutos: minutos,
          delayEnvioMs: delay
        })
      });

      if (res.ok) {
        alert(`üíæ Configura√ß√µes atualizadas! Intervalo: ${minutos} min | Delay: ${delay} ms`);
      } else {
        const erro =  await res.json();
        alert(`‚ùå Erro ao atualizar: ${erro.error}`);
      }
    }

    function abrirQrCode() {
      modalQr.show();
    }

    async function desconectarBot() {
      if (!confirm('Deseja mesmo desconectar do WhatsApp?')) return;
      const res = await fetch(`${API_BOT}/api/desconectar`, { method: 'POST' });
      if (res.ok) {
        alert('üîå Desconectado do WhatsApp!');
      } else {
        const erro = await res.json();
        alert('‚ùå Erro ao desconectar: ' + erro.error);
      }
      verificarStatus();
    }

    function acaoBot() {
      // Placeholder, controlado dinamicamente por verificarStatus
    }

    // üîó Sockets
    socket.on('log', msg => {
      const logs = document.getElementById('logs');
      const hora = new Date().toLocaleTimeString('pt-BR', { hour: "2-digit", minute: "2-digit", second: "2-digit"});
      logs.innerHTML += `<div><span class="timestamp">[${hora}]</span> ‚û§ ${msg}</div>`;
      logs.scrollTop = logs.scrollHeight;
    });

    socket.on('qr', qrData => {
      const qr = `<img src="${qrData}" alt="QR Code" class="img-fluid" style="max-width: 250px;">`;
      document.getElementById('qrcode').innerHTML = qr;
      modalQr.show();
      verificarStatus();
    });

    socket.on('status', status => {
      verificarStatus();
      if (status === 'conectado') {
        modalQr.hide();
      }
    });

    // üî• Hist√≥rico de Mensagens
    async function carregarMensagens() {
      const res = await fetch('/api/mensagens');
      const dados = await res.json();
      const tbody = document.getElementById('tabela-mensagens');
      tbody.innerHTML = '';
      const contagemPorGrupo = {};
      for (const grupoId in dados) {
        for (const msg of dados[grupoId]) {
          const linha = `
            <tr>
              <td>${msg.nomeGrupo}</td>
              <td>${msg.mensagem}</td>
              <td>${new Date(msg.horario).toLocaleString()}</td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', linha);
          contagemPorGrupo[msg.nomeGrupo] = (contagemPorGrupo[msg.nomeGrupo] || 0) + 1;
        }
      }
      desenharGrafico(contagemPorGrupo);
    }

    function desenharGrafico(contagem) {
      const ctx = document.getElementById('chart').getContext('2d');
      if (window.grafico) window.grafico.destroy();
      window.grafico = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(contagem),
          datasets: [{
            label: 'Mensagens por Grupo',
            data: Object.values(contagem),
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // üîß Controle de Agendamento
    async function iniciarBot() {
      await fetch(`${API_BOT}/api/iniciar`, { method: 'POST' });
      alert('‚úÖ Bot iniciado');
    }

    async function pararBot() {
      await fetch(`${API_BOT}/api/parar`, { method: 'POST' });
      alert('‚èπÔ∏è Bot parado');
    }
    
    // sincronizar e exibir grupos
    async function carregarGruposNaoSync() {
      const res = await fetch('/api/grupos-nao-sincronizados');
      const grupos = await res.json();
      const tbody = document.getElementById('tabela-grupos-nao-sync');
      tbody.innerHTML = '';

      if (grupos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center">üéâ Todos os grupos est√£o sincronizados!</td></tr>`;
        return;
      }

      grupos.forEach(grupo => {
        const linha = `
          <tr>
            <td>${grupo.name}</td>
            <td><code>${grupo.id}</code></td>
            <td><button class="btn btn-sm btn-success" onclick="sincronizarGrupo('${grupo.id}', '${grupo.name.replace(/'/g, "\\'")}')">‚ûï Sincronizar</button></td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', linha);
      });
    }

    async function sincronizarGrupo(id, name) {
      const confirmacao = confirm(`Deseja realmente sincronizar o grupo "${name}"?`);
      if (!confirmacao) return;

      const res = await fetch('/api/sincronizar-grupo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json'},
        body: JSON.stringify({ id, name })
      });

      if (res.ok) {
        alert(`‚úÖ Grupo "${name}" sincronizado!`);
        carregarGruposNaoSync();
      } else {
        const erro = await res.json();
        alert(`‚ùå Erro ao sincronizar: ${erro.error}`);
      }
    }

    // local storage para salvar se√ßao 
    document.querySelectorAll('#tabs a').forEach(tab => {
      tab.addEventListener('show.bs.tab', function (e) {
        localStorage.setItem('activeTab', e.target.getAttribute('href'));
      });
    });

    const activeTab = localStorage.getItem('activeTab');
    if (activeTab) {
      const someTabTriggerEl = document.querySelector(`#tabs a[href="${activeTab}"]`);
      if (someTabTriggerEl) {
        const tab = new bootstrap.Tab(someTabTriggerEl);
        tab.show();
      }
    }

    // üèÅ Inicializa√ß√£o
    carregarConfig();
    verificarStatus();
    verificarSaude(); // <--- CHAMADA INICIAL
    carregarMensagens();
    setInterval(verificarStatus, 10000);
    setInterval(carregarMensagens, 60000);
    setInterval(carregarGruposNaoSync, 60000);
    setInterval(verificarSaude, 30000); // <--- ATUALIZA√á√ÉO PERI√ìDICA
  </script>
</body>
</html>